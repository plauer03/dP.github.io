<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date Planner PWA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script type="module">
        import { createIcons, icons } from 'https://unpkg.com/lucide@latest';
        window.lucide = { createIcons, icons };
    </script>
    <style>
        /* Modern, minimalistisches Design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* Sehr helles Grau */
            color: #374151; /* Dunkelgrauer Text */
            min-height: 100vh;
        }
        /* Mobile Viewport Fix */
        #app-container {
            max-width: 640px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding-bottom: 80px; /* Platz für die Bottom Nav */
        }
        /* Style für den FAB */
        #fab-button {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .modal-content {
            /* Für das iPhone-typische Verhalten, Modal von unten einblenden */
            transition: transform 0.3s ease-out;
            transform: translateY(100%);
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <div id="app-container">
        <!-- Header mit Suchleiste wird hier gerendert -->
        <header id="header-container" class="sticky top-0 bg-gray-50 p-4 border-b border-gray-200 z-10"></header>

        <!-- Hauptinhalt (Listen/Konto) -->
        <main id="main-content" class="flex-grow p-4"></main>

        <!-- Floating Action Button (FAB) -->
        <button id="fab-button" class="fixed bottom-[80px] right-4 w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center transition-all duration-300 transform active:scale-90 z-20" aria-label="Neues Date hinzufügen">
            <svg id="plus-icon" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 flex justify-around shadow-2xl z-20 w-full sm:max-w-xl mx-auto"></nav>
    </div>

    <!-- Modals werden hier gerendert -->
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Firebase Konfiguration
        // WICHTIG: Ersetze diese mit deinen echten Werten!
        const EXTERNAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCHy4CrrAxKuLf_HPrA3_4ytSzhuEciiJE", 
            authDomain: "dateplanner-6ed32.firebaseapp.com", 
            projectId: "dateplanner-6ed32", 
            storageBucket: "dateplanner-6ed32.firebasestorage.app", 
            messagingSenderId: "791640067999", 
            appId: "1:791640067999:web:eecf6d61690adaf9b1f7aa", 
            measurementId: "G-W371VT4B3Z" 
        };

        const firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialisiere Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Globale App-Zustände
        let dates = [];
        let activeTab = 'planned'; // 'planned', 'completed', 'account'
        let user = null;
        let userId = null;
        let isAuthReady = false;
        let showAddModal = false;
        let showCompleteModal = false;
        let selectedDate = null;
        let searchQuery = '';
        let error = null;

        // --- Hilfsfunktionen ---

        const getDatesCollectionRef = (uid) => {
            // Öffentlicher Pfad für einfache Gruppierung
            const groupId = uid;
            return collection(db, `artifacts/${appId}/public/data/dates-${groupId}`);
        };

        const renderIcon = (name, classes) => {
            // Simuliert Lucide-Icons (da wir keine direkten React-Imports haben)
            // Stattdessen rendern wir die SVG-Daten direkt oder verlassen uns auf window.lucide, falls verfügbar.
            // Für die Einfachheit nutzen wir nur eine `<svg>` für den Plus-Button, aber für andere Icons ist es komplizierter.
            // Da wir Tailwind verwenden, wird der Icon-Satz direkt in der Datei als String gerendert,
            // um sicherzustellen, dass es funktioniert.
            const iconMap = {
                'Calendar': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"></path><path d="M16 2v4"></path><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"></path><path d="M7 13h10"></path><path d="M7 17h5"></path><path d="M16 19h6"></path><path d="M19 16v6"></path></svg>`,
                'CheckSquare': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>`,
                'User': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
                'Search': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
                'Trash2': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
                'X': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
                'Image': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9.5" cy="9.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`,
                'Loader': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>`,
                'LogOut': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`,
                'Send': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`,
                'Aperture': `<svg class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19a7 7 0 1 0 0-14 7 7 0 0 0 0 14Z"></path><path d="M14.32 14.32a6 6 0 1 1-8.64-8.64"></path><path d="M21 21L14.32 14.32"></path></svg>`
            };
            return iconMap[name] || '';
        };

        const dispatchRender = () => {
            renderApp();
            // Optional: Rendert Icons nach dem DOM-Update, falls lucide verfügbar ist.
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        };

        const toggleModal = (modalType, visible, date = null) => {
            const container = document.getElementById('modal-container');
            if (!container) return;

            // Schließe alle Modals
            showAddModal = false;
            showCompleteModal = false;
            selectedDate = null;

            if (visible) {
                if (modalType === 'addEdit') {
                    showAddModal = true;
                    selectedDate = date;
                    renderAddEditModal();
                } else if (modalType === 'complete') {
                    showCompleteModal = true;
                    selectedDate = date;
                    renderCompleteModal();
                }
                document.body.classList.add('modal-open');
            } else {
                container.innerHTML = '';
                document.body.classList.remove('modal-open');
            }
        };

        // --- Event Handler ---

        const handleAddDate = async (title, notes) => {
            if (!userId || !title.trim()) {
                console.error("Titel fehlt oder Benutzer nicht angemeldet.");
                return;
            }
            try {
                await addDoc(getDatesCollectionRef(userId), {
                    title: title.trim(),
                    notes: notes.trim(),
                    status: 'planned',
                    userId: userId,
                    createdAt: serverTimestamp(),
                });
                toggleModal('addEdit', false);
            } catch (e) {
                console.error("Fehler beim Hinzufügen des Dates:", e);
                setError(`Fehler beim Speichern: ${e.message}`);
                dispatchRender();
            }
        };

        const handleDeleteDate = async (id) => {
            if (!userId || !id) return;
            try {
                await deleteDoc(doc(getDatesCollectionRef(userId), id));
                toggleModal('addEdit', false);
            } catch (e) {
                console.error("Fehler beim Löschen des Dates:", e);
                setError(`Fehler beim Löschen: ${e.message}`);
                dispatchRender();
            }
        };

        const handleCompleteDate = async (dateId, file, notes) => {
            if (!userId || !dateId) return;

            let imageUrl = null;
            let uploadError = null;
            const completeBtn = document.getElementById('complete-submit');
            if (completeBtn) {
                completeBtn.disabled = true;
                completeBtn.innerHTML = `${renderIcon('Loader', 'w-5 h-5 mr-2 animate-spin inline-block')} Wird hochgeladen...`;
            }

            if (file && storage) {
                try {
                    const imageRef = ref(storage, `date-images/${userId}/${dateId}-${Date.now()}-${file.name}`);
                    const snapshot = await uploadBytes(imageRef, file);
                    imageUrl = await getDownloadURL(snapshot.ref);
                } catch (e) {
                    console.error("Fehler beim Hochladen des Bildes:", e);
                    uploadError = "Bild konnte nicht hochgeladen werden. Date wird trotzdem als erledigt markiert.";
                }
            }

            try {
                await updateDoc(doc(getDatesCollectionRef(userId), dateId), {
                    status: 'completed',
                    completedAt: serverTimestamp(),
                    imageUrl: imageUrl,
                    completionNotes: notes,
                });
                toggleModal('complete', false);
                if (uploadError) {
                    setError(uploadError);
                    dispatchRender();
                }
            } catch (e) {
                console.error("Fehler beim Aktualisieren des Dates:", e);
                setError(`Fehler beim Abschließen: ${e.message}`);
                dispatchRender();
            }
        };

        const handleSetInProgress = (date) => {
            // "Details/Löschen" Button
            toggleModal('addEdit', true, date);
        };

        // --- Render Funktionen ---

        const renderErrorBox = () => {
            if (!error) return '';
            return `
                <div class="p-4 rounded-lg bg-red-50 border border-red-300 text-red-700 mb-4 flex justify-between items-center">
                    <div>
                        <p class="font-bold">Fehler:</p>
                        <p class="text-sm">${error}</p>
                    </div>
                    <button id="error-close-btn" class="p-1 rounded-full hover:bg-red-100">${renderIcon('X', 'w-4 h-4')}</button>
                </div>
            `;
        };

        const renderHeader = () => {
            const container = document.getElementById('header-container');
            if (!container) return;

            if (error) {
                 container.innerHTML = renderErrorBox();
                 document.getElementById('error-close-btn').onclick = () => { error = null; dispatchRender(); };
                 return;
            }

            if (activeTab !== 'account') {
                container.innerHTML = `
                    <div class="flex items-center">
                        ${renderIcon('Search', 'w-5 h-5 mr-3 text-gray-400')}
                        <input
                            type="text"
                            placeholder="Suchen in ${activeTab === 'planned' ? 'Geplant' : 'Erledigt'}..."
                            id="search-input"
                            value="${searchQuery}"
                            class="w-full p-2 rounded-lg bg-white border border-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-150 text-base shadow-sm"
                        />
                    </div>
                `;
                document.getElementById('search-input').oninput = (e) => {
                    searchQuery = e.target.value;
                    dispatchRender();
                };
            } else {
                container.innerHTML = `<h1 class="text-xl font-bold text-gray-800">Konto</h1>`;
            }
        };

        const renderBottomNav = () => {
            const container = document.getElementById('bottom-nav');
            if (!container) return;

            const tabs = [
                { id: 'planned', label: 'Geplant', icon: 'Calendar' },
                { id: 'completed', label: 'Erledigt', icon: 'CheckSquare' },
                { id: 'account', label: 'Konto', icon: 'User' }
            ];

            container.innerHTML = tabs.map(({ id, label, icon }) => {
                const isActive = activeTab === id;
                const activeClasses = isActive ? 'text-blue-600' : 'text-gray-400 hover:text-gray-600';
                const buttonClasses = isActive ? 'bg-blue-50/70' : 'hover:bg-gray-100';

                return `
                    <button data-tab="${id}" class="nav-item flex flex-col items-center p-2 rounded-lg transition duration-150 ${buttonClasses}">
                        ${renderIcon(icon, `w-6 h-6 ${activeClasses}`)}
                        <span class="text-xs mt-1 font-medium ${isActive ? 'text-blue-600' : 'text-gray-600'}">
                            ${label}
                        </span>
                    </button>
                `;
            }).join('');

            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => {
                    activeTab = btn.getAttribute('data-tab');
                    searchQuery = ''; // Suchleiste leeren beim Tab-Wechsel
                    dispatchRender();
                };
            });
        };

        const renderDateCard = (date, type) => {
            const formattedDate = date.createdAt?.toDate ? date.createdAt.toDate().toLocaleDateString('de-DE', { dateStyle: 'medium' }) : 'Unbekanntes Datum';
            const cardHtml = `
                <div class="p-4 rounded-xl bg-white shadow-md flex flex-col space-y-3 transition duration-150 border border-gray-100 hover:border-blue-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">${date.title}</h3>
                            <p class="text-gray-500 text-sm mt-1">${date.notes}</p>
                        </div>
                        <span class="text-xs text-gray-400 italic">${formattedDate}</span>
                    </div>

                    ${type === 'completed' ? `
                        ${date.imageUrl ? `
                            <div class="mt-2">
                                <img
                                    src="${date.imageUrl}"
                                    alt="Erledigtes Date: ${date.title}"
                                    class="w-full h-32 object-cover rounded-lg shadow-inner"
                                    onerror="this.onerror=null; this.src='https://placehold.co/400x128/f3f4f6/6b7280?text=Kein+Bild';"
                                />
                                ${date.completionNotes ? `<p class="text-gray-500 text-xs mt-2">Notiz: ${date.completionNotes}</p>` : ''}
                            </div>
                        ` : '<p class="text-gray-400 text-sm">Kein Bild hochgeladen.</p>'}
                    ` : `
                        <div class="flex justify-end space-x-2 pt-2">
                            <button data-id="${date.id}" class="action-details px-4 py-2 text-sm font-semibold rounded-full bg-gray-100 text-blue-600 hover:bg-gray-200 transition duration-150">
                                Details/Löschen
                            </button>
                            <button data-id="${date.id}" class="action-complete px-4 py-2 text-sm font-semibold rounded-full bg-blue-600 text-white hover:bg-blue-700 transition duration-150 transform active:scale-95">
                                ${renderIcon('CheckSquare', 'w-4 h-4 mr-1 inline-block')} Erledigt
                            </button>
                        </div>
                    `}
                </div>
            `;
            return cardHtml;
        };

        const renderDateListView = (type) => {
            const statusFilter = type === 'planned' ? 'planned' : 'completed';
            const filteredDates = dates
                .filter(d => d.status === statusFilter)
                .filter(d => searchQuery === '' || d.title.toLowerCase().includes(searchQuery.toLowerCase()));

            const completedCount = dates.filter(d => d.status === 'completed').length;
            const title = type === 'planned' ? 'Geplante Dates' : `Erledigte Dates (${completedCount})`;
            let content = '';

            if (filteredDates.length === 0) {
                content = `
                    <div class="text-center p-8 mt-10">
                        ${renderIcon('Aperture', 'w-10 h-10 mx-auto mb-3 text-gray-400')}
                        <h3 class="text-lg font-semibold text-gray-800">Keine Dates gefunden</h3>
                        <p class="text-gray-500">
                            ${type === 'planned' ? 'Füge mit dem Plus-Button unten rechts ein neues Date hinzu.' : 'Sobald du ein Date abschließt, erscheint es hier.'}
                        </p>
                    </div>
                `;
            } else {
                content = filteredDates.map(date => renderDateCard(date, type)).join('');
            }

            const viewHtml = `
                <h2 class="text-xl font-bold mb-4 text-gray-800">${title}</h2>
                <div class="space-y-4">${content}</div>
            `;

            return viewHtml;
        };

        const renderAccountView = () => {
            const displayName = user?.email || `Benutzer ID: ${userId ? userId.substring(0, 8) + '...' : 'Unbekannt'}`;
            const defaultPhoto = 'https://placehold.co/100x100/e5e7eb/6b7280?text=U'; // Heller Platzhalter

            return `
                <div class="space-y-6 p-4">
                    <div class="p-6 bg-white rounded-xl shadow-lg flex flex-col items-center space-y-4 border border-gray-100">
                        <div class="relative">
                            <img
                                src="${user?.photoURL || defaultPhoto}"
                                alt="Profilbild"
                                class="w-24 h-24 rounded-full object-cover border-4 border-blue-500/50"
                                onerror="this.onerror=null; this.src='${defaultPhoto}';"
                            />
                        </div>
                        <h2 class="text-2xl font-bold text-gray-800">${displayName.split('@')[0]}</h2>
                        <p class="text-gray-500 text-sm text-center">
                            ${user?.isAnonymous ? 'Anonyme Anmeldung. Deine Dates werden unter dieser ID gespeichert:' : 'Angemeldet via E-Mail/Token.'}
                        </p>
                        <p class="text-xs text-center break-all text-gray-500 p-2 bg-gray-100 rounded-lg shadow-inner">
                            **Deine Gruppen-ID:** ${userId}
                        </p>
                    </div>

                    <div class="p-4 bg-white rounded-xl shadow-lg space-y-4 border border-gray-100">
                        <h3 class="text-lg font-semibold text-gray-800">Gruppenfunktion (Simuliert)</h3>
                        <p class="text-gray-500 text-sm">
                            Um Dates zu teilen, melde dich mit der gleichen **Gruppen-ID** (oben angezeigt) an.
                        </p>
                    </div>

                    <button id="logout-btn" class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-semibold py-3 rounded-full shadow-lg transition duration-150 transform active:scale-95">
                        ${renderIcon('LogOut', 'w-5 h-5 mr-2')} Abmelden
                    </button>
                </div>
            `;
        };

        const renderMainContent = () => {
            const container = document.getElementById('main-content');
            if (!container) return;

            let html = '';
            if (activeTab === 'planned') {
                html = renderDateListView('planned');
            } else if (activeTab === 'completed') {
                html = renderDateListView('completed');
            } else if (activeTab === 'account') {
                html = renderAccountView();
            }

            container.innerHTML = html;
        };

        const renderModals = () => {
            if (showAddModal) {
                renderAddEditModal();
            } else if (showCompleteModal) {
                renderCompleteModal();
            } else {
                document.getElementById('modal-container').innerHTML = '';
            }
        };

        const renderAddEditModal = () => {
            const container = document.getElementById('modal-container');
            const date = selectedDate;
            const isEdit = !!date;
            const title = isEdit ? 'Date bearbeiten' : 'Neues Date hinzufügen';

            container.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-40 flex items-end justify-center p-0 z-30 transition-opacity duration-300">
                    <div id="add-edit-content" class="modal-content w-full sm:max-w-lg bg-white rounded-t-xl sm:rounded-xl shadow-2xl text-gray-800 transform transition-all duration-300 translate-y-full">
                        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                            <h2 class="text-lg font-bold">${title}</h2>
                            <button id="add-edit-close" class="p-2 rounded-full hover:bg-gray-100 transition duration-150">
                                ${renderIcon('X', 'w-5 h-5 text-gray-600')}
                            </button>
                        </div>
                        <form id="add-edit-form" class="p-5 space-y-4">
                            <div>
                                <label class="text-gray-500 block text-sm font-medium mb-1">Beschreibung (z.B. Picknick)</label>
                                <input
                                    type="text"
                                    id="date-title"
                                    value="${date?.title || ''}"
                                    class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-150"
                                    placeholder="Was ist geplant?"
                                    required
                                />
                            </div>
                            <div>
                                <label class="text-gray-500 block text-sm font-medium mb-1">Notizen (z.B. Datum/Ort)</label>
                                <textarea
                                    id="date-notes"
                                    rows="3"
                                    class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-150"
                                    placeholder="Datum, Ort, andere Details..."
                                >${date?.notes || ''}</textarea>
                            </div>

                            <div class="flex justify-between items-center pt-4">
                                ${isEdit ? `
                                    <button type="button" id="delete-btn" class="flex items-center text-red-500 hover:text-red-700 p-2 rounded-lg transition duration-150">
                                        ${renderIcon('Trash2', 'w-5 h-5 mr-1')} Löschen
                                    </button>
                                ` : '<div></div>'}
                                <button
                                    type="submit"
                                    id="save-btn"
                                    class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg transition duration-150 transform active:scale-95 hover:bg-blue-700"
                                >
                                    ${renderIcon('Send', 'w-5 h-5 mr-2 inline-block')} ${isEdit ? 'Speichern' : 'Hinzufügen'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            // Trigger animation
            setTimeout(() => document.getElementById('add-edit-content')?.classList.remove('translate-y-full'), 10);

            // Event Listener
            document.getElementById('add-edit-close').onclick = () => toggleModal('addEdit', false);
            if (isEdit) {
                document.getElementById('delete-btn').onclick = () => handleDeleteDate(date.id);
            }
            document.getElementById('add-edit-form').onsubmit = (e) => {
                e.preventDefault();
                const title = document.getElementById('date-title').value;
                const notes = document.getElementById('date-notes').value;
                handleAddDate(title, notes); // Re-use handleAddDate for simplicity (it only creates new ones now)
                // For a proper edit, we would need to implement handleUpdateDate here.
            };
        };

        const renderCompleteModal = () => {
            const container = document.getElementById('modal-container');
            const date = selectedDate;

            container.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-40 flex items-end justify-center p-0 z-30 transition-opacity duration-300">
                    <div id="complete-content" class="modal-content w-full sm:max-w-lg bg-white rounded-t-xl sm:rounded-xl shadow-2xl text-gray-800 transform transition-all duration-300 translate-y-full">
                        <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                            <h2 class="text-lg font-bold">'${date.title}' als erledigt markieren</h2>
                            <button id="complete-close" class="p-2 rounded-full hover:bg-gray-100 transition duration-150">
                                ${renderIcon('X', 'w-5 h-5 text-gray-600')}
                            </button>
                        </div>
                        <form id="complete-form" class="p-5 space-y-4">
                            <p class="text-gray-500 text-sm">
                                Möchtest du ein Bild hochladen, um das abgeschlossene Date zu dokumentieren? (Optional)
                            </p>

                            <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                                <label for="image-upload" id="image-upload-label" class="cursor-pointer flex items-center justify-center p-3 border-2 border-dashed border-blue-300/50 rounded-lg transition duration-150 hover:bg-gray-100">
                                    ${renderIcon('Image', 'w-6 h-6 mr-2 text-blue-500')}
                                    Bild auswählen oder machen...
                                </label>
                                <input id="image-upload" type="file" accept="image/*" capture="environment" class="hidden" />
                                <p id="file-status" class="text-xs mt-2 text-gray-500 hidden">Bild bereit zum Hochladen.</p>
                            </div>

                            <div>
                                <label class="text-gray-500 block text-sm font-medium mb-1">Kurze Notiz zur Erledigung</label>
                                <textarea
                                    id="complete-notes"
                                    rows="2"
                                    class="w-full p-3 rounded-lg bg-gray-50 border border-gray-200 focus:ring-2 focus:ring-blue-500 transition duration-150"
                                    placeholder="Wie war es?"
                                ></textarea>
                            </div>

                            <button
                                type="submit"
                                id="complete-submit"
                                class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold py-3 rounded-full shadow-lg transition duration-150 transform active:scale-95 hover:bg-blue-700"
                            >
                                ${renderIcon('CheckSquare', 'w-5 h-5 mr-2')} Als erledigt speichern
                            </button>
                        </form>
                    </div>
                </div>
            `;
            // Trigger animation
            setTimeout(() => document.getElementById('complete-content')?.classList.remove('translate-y-full'), 10);

            // Event Listener
            let fileToUpload = null;
            const fileStatus = document.getElementById('file-status');
            const fileLabel = document.getElementById('image-upload-label');

            document.getElementById('complete-close').onclick = () => toggleModal('complete', false);

            document.getElementById('image-upload').onchange = (e) => {
                if (e.target.files && e.target.files[0]) {
                    fileToUpload = e.target.files[0];
                    fileStatus.textContent = `Bild ausgewählt: ${fileToUpload.name}`;
                    fileStatus.classList.remove('hidden');
                    fileLabel.innerHTML = `${renderIcon('Image', 'w-6 h-6 mr-2 text-blue-500')} ${fileToUpload.name}`;
                }
            };

            document.getElementById('complete-form').onsubmit = (e) => {
                e.preventDefault();
                const notes = document.getElementById('complete-notes').value;
                handleCompleteDate(date.id, fileToUpload, notes);
            };
        };

        // --- Haupt-Render-Schleife und Event-Zuweisung ---

        const renderApp = () => {
            renderHeader();
            renderBottomNav();
            renderMainContent();
            renderModals(); // Stellt sicher, dass Modals korrekt geöffnet/geschlossen werden

            // Event Listener für FAB
            const fab = document.getElementById('fab-button');
            if (fab) {
                fab.onclick = () => toggleModal('addEdit', true, null);
            }

            // Event Listener für dynamisch erstellte Buttons
            document.querySelectorAll('.action-details').forEach(btn => {
                btn.onclick = (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const date = dates.find(d => d.id === id);
                    if (date) handleSetInProgress(date);
                };
            });

            document.querySelectorAll('.action-complete').forEach(btn => {
                btn.onclick = (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    const date = dates.find(d => d.id === id);
                    if (date) toggleModal('complete', true, date);
                };
            });

            // Event Listener für Abmelden
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.onclick = async () => {
                    try {
                        await signOut(auth);
                        // Nach dem Abmelden führt onAuthStateChanged automatisch zur erneuten anonymen Anmeldung
                    } catch (e) {
                        console.error("Fehler beim Abmelden:", e);
                        setError("Fehler beim Abmelden.");
                        dispatchRender();
                    }
                };
            }
        };

        // --- Initialisierung und Authentifizierung ---

        const startListeners = (uid) => {
            if (!uid) return;

            // Firestore Listener
            const q = query(getDatesCollectionRef(uid));
            onSnapshot(q, (snapshot) => {
                dates = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Firestore Timestamp in JS Date konvertieren
                    createdAt: doc.data().createdAt?.toDate ? doc.data().createdAt : null,
                })).sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0));

                renderApp();
            }, (e) => {
                console.error("Fehler beim Abrufen der Dates:", e);
                setError("Fehler beim Laden der Dates. Überprüfe die Firestore-Regeln.");
                renderApp();
            });
        };

        const initializeAuth = () => {
            onAuthStateChanged(auth, async (currentUser) => {
                if (currentUser) {
                    user = currentUser;
                    userId = currentUser.uid;
                } else {
                    try {
                        // Custom Token verwenden, falls vorhanden (Canvas-Umgebung)
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // Anonyme Anmeldung als Fallback
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Fehler bei der Authentifizierung:", e);
                        setError("Fehler bei der Benutzeranmeldung. Bitte versuche es später erneut.");
                    }
                }
                if (!isAuthReady && userId) {
                    isAuthReady = true;
                    startListeners(userId);
                }
                renderApp(); // Initiales Rendering nach Auth-Status
            });
        };

        // Starte die App
        document.addEventListener('DOMContentLoaded', initializeAuth);
    </script>
</body>
</html>
